<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Practice | Speaking</title>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <style>
    :root {
      --bg: #0b1120;
      --card: rgba(255,255,255,0.06);
      --accent: #00ff9d;
      --danger: #ff4d6a;
      --text: #e0f7ff;
      --text-muted: #94a3b8;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      height: 100dvh;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
      display: grid;
      place-items: center;
      overflow: hidden;
    }
    .card {
      background: var(--card);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 28px;
      padding: 2.8rem 2rem;
      width: min(92vw, 420px);
      box-shadow: 0 30px 70px -20px rgba(0,0,0,0.6);
      text-align: center;
    }
    #word-image {
      width: 100%;
      height: 220px;
      object-fit: cover;
      border-radius: 16px;
      background: #000;
      margin-bottom: 1.8rem;
      box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    }
    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      letter-spacing: 1.5px;
      color: var(--accent);
      margin-bottom: 2rem;
      text-transform: capitalize;
    }
    button {
      width: 100%;
      padding: 1.1rem;
      margin-bottom: 1rem;
      border-radius: 16px;
      border: none;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.22s ease;
      user-select: none;
    }
    .btn-listen {
      background: white;
      color: #0f172a;
    }
    .btn-listen:hover { background: #f1f5f9; transform: translateY(-1px); }
    .btn-speak {
      background: rgba(0, 255, 157, 0.12);
      color: var(--accent);
      border: 1.5px solid var(--accent);
    }
    .btn-speak:hover:not(:disabled) {
      background: rgba(0, 255, 157, 0.22);
      transform: translateY(-1px);
    }
    .btn-speak.active {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
      animation: pulse 1.8s infinite ease-in-out;
    }
    @keyframes pulse {
      0%,100% { transform: scale(1); }
      50% { transform: scale(1.04); }
    }
    #msg {
      min-height: 2.4rem;
      margin-top: 1.2rem;
      font-size: 1.05rem;
      font-weight: 500;
      line-height: 1.45;
    }
    .success { color: var(--accent); }
    .error { color: var(--danger); }
  </style>
</head>
<body>
<div class="card">
  <img id="word-image" src="" alt="Word visual" crossorigin="anonymous">
  <h1 id="target-text">...</h1>
  <button class="btn-listen" type="button" onclick="playWord()">ðŸ”Š Listen</button>
  <button id="speakBtn" class="btn-speak" type="button">ðŸŽ¤ Start Speaking</button>
  <div id="msg"></div>
</div>

<script>
const msgEl = document.getElementById('msg');
const speakBtn = document.getElementById('speakBtn');
const targetEl = document.getElementById('target-text');
const imageEl = document.getElementById('word-image');

const API_KEY = 'AIzaSyBieeiaZK_uiMBxZEBjPmq0tmF6PYg_j9g'; // â† BurasÄ± senin anahtarÄ±n (Ã¼cretsiz tier'da audio iÃ§in kota Ã§ok dÃ¼ÅŸÃ¼k olabilir â†’ 20-50 istek/gÃ¼n gibi)

let targetWord = "test";
let wordList = [];
let currentItem = null;
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;
let audioStream = null;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showMessage(text, className = '') {
  msgEl.innerHTML = text;
  msgEl.className = className;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playWord() {
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(targetWord);
  u.lang = 'en-US';
  u.rate = 1.0;
  u.pitch = 1.0;
  speechSynthesis.speak(u);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleRecording() {
  if (isRecording) {
    // KaydÄ± durdur
    mediaRecorder.stop();
    speakBtn.classList.remove('active');
    speakBtn.textContent = 'ðŸŽ¤ Start Speaking';
    showMessage('Processing...');
    isRecording = false;
  } else {
    // Kayda baÅŸla
    try {
      audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(audioStream, { mimeType: 'audio/webm' });
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const reader = new FileReader();
        reader.readAsDataURL(audioBlob);
        reader.onloadend = async () => {
          const base64Audio = reader.result.split(',')[1];
          await analyzeWithGemini(base64Audio);
        };
        audioStream.getTracks().forEach(track => track.stop());
      };

      mediaRecorder.start();
      speakBtn.classList.add('active');
      speakBtn.textContent = 'ðŸ›‘ Stop & Check';
      showMessage('Speak clearly now...');
      isRecording = true;
    } catch (err) {
      showMessage('Microphone access denied or error: ' + err.message, 'error');
    }
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function analyzeWithGemini(base64Audio) {
  try {
    const MODEL = 'gemini-2.5-flash'; // 2026'da audio iÃ§in daha stabil

    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              {
                text: `Transcribe this spoken word exactly. Check if it matches "${targetWord.toLowerCase()}" perfectly (ignore accent/noise). Reply ONLY with "yes" or "no" (lowercase, no extra text).`
              },
              {
                inlineData: {
                  mimeType: 'audio/webm',
                  data: base64Audio
                }
              }
            ]
          }],
          generationConfig: {
            temperature: 0.0,
            maxOutputTokens: 5
          }
        })
      }
    );

    if (!res.ok) {
      const errText = await res.text();
      throw new Error(`API error ${res.status}: ${errText}`);
    }

    const data = await res.json();
    let text = (data.candidates?.[0]?.content?.parts?.[0]?.text || '').trim().toLowerCase();

    // Gemini bazen fazladan karakter ekleyebiliyor â†’ temizle
    text = text.includes('yes') ? 'yes' : 'no';

    const isCorrect = text === 'yes';

    currentItem.tries = (currentItem.tries || 0) + 1;
    if (isCorrect) {
      currentItem.hits = (currentItem.hits || 0) + 1;
      showMessage('âœ“ Perfect match!', 'success');
      confetti({ particleCount: 140, spread: 90, origin: { y: 0.6 } });
    } else {
      showMessage(`âœ— Not a match. Try again! (heard something else)`, 'error');
    }

    localStorage.setItem('subjectWords', JSON.stringify(wordList));
  } catch (err) {
    console.error(err);
    let msg = 'Error: ' + err.message;
    if (err.message.includes('429') || err.message.includes('quota')) {
      msg += ' â†’ Free tier quota exceeded. Enable billing or wait 24h.';
    }
    showMessage(msg, 'error');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  const params = new URLSearchParams(location.search);
  const key = params.get('key')?.trim().toLowerCase();
  if (!key) {
    targetEl.textContent = '(no key)';
    showMessage('Missing ?key= in URL', 'error');
    return;
  }

  try {
    wordList = JSON.parse(localStorage.getItem('subjectWords') || '[]');
  } catch {
    wordList = [];
  }

  currentItem = wordList.find(w => 
    w.name?.toLowerCase() === key || w.scrambled?.toLowerCase() === key
  );

  if (!currentItem?.name) {
    targetWord = key;
    targetEl.textContent = key;
    imageEl.src = '';
    showMessage('Word not in storage â€“ using key as word', 'error');
    return;
  }

  targetWord = currentItem.name;
  targetEl.textContent = targetWord;
  imageEl.src = currentItem.img || '';
  imageEl.onerror = () => { imageEl.style.display = 'none'; };
}

init();
speakBtn.onclick = toggleRecording;
</script>
</body>
</html>
