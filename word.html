<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Practice | Speaking</title>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    :root {
      --bg: #0b1120;
      --card: rgba(255,255,255,0.06);
      --accent: #00ff9d;
      --danger: #ff4d6a;
      --text: #e0f7ff;
      --text-muted: #94a3b8;
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      height: 100dvh;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    .card {
      background: var(--card);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 28px;
      padding: 2.8rem 2rem;
      width: min(92vw, 420px);
      box-shadow: 0 30px 70px -20px rgba(0,0,0,0.6);
      text-align: center;
    }

    #word-image {
      width: 100%;
      height: 220px;
      object-fit: cover;
      border-radius: 16px;
      background: #000;
      margin-bottom: 1.8rem;
      box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      letter-spacing: 1.5px;
      color: var(--accent);
      margin-bottom: 2rem;
      text-transform: capitalize;
    }

    button {
      width: 100%;
      padding: 1.1rem;
      margin-bottom: 1rem;
      border-radius: 16px;
      border: none;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.22s ease;
      user-select: none;
    }

    .btn-listen {
      background: white;
      color: #0f172a;
    }
    .btn-listen:hover { background: #f1f5f9; transform: translateY(-1px); }

    .btn-speak {
      background: rgba(0, 255, 157, 0.12);
      color: var(--accent);
      border: 1.5px solid var(--accent);
    }

    .btn-speak:hover:not(:disabled) {
      background: rgba(0, 255, 157, 0.22);
      transform: translateY(-1px);
    }

    .btn-speak.active {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
      animation: pulse 1.8s infinite ease-in-out;
    }

    @keyframes pulse {
      0%,100% { transform: scale(1); }
      50%     { transform: scale(1.04); }
    }

    #msg {
      min-height: 2.4rem;
      margin-top: 1.2rem;
      font-size: 1.05rem;
      font-weight: 500;
      line-height: 1.45;
    }

    .success { color: var(--accent); }
    .error   { color: var(--danger); }
  </style>
</head>
<body>

<div class="card">
  <img id="word-image" src="" alt="Word visual" crossorigin="anonymous">
  <h1 id="target-text">...</h1>

  <button class="btn-listen" type="button" onclick="playWord()">ðŸ”Š Listen</button>
  <button id="speakBtn" class="btn-speak" type="button">ðŸŽ¤ Speak to Practice</button>

  <div id="msg"></div>
</div>

<script>
const msgEl     = document.getElementById('msg');
const speakBtn  = document.getElementById('speakBtn');
const targetEl  = document.getElementById('target-text');
const imageEl   = document.getElementById('word-image');

let recognition = null;
let targetWord  = "test";
let wordList    = [];
let currentItem = null;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showMessage(text, className = '') {
  msgEl.innerHTML = text;
  msgEl.className = className;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playWord() {
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(targetWord);
  u.lang = 'en-US';
  u.rate = 1.0;
  u.pitch = 1.0;
  speechSynthesis.speak(u);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startRecognition() {
  const SpeechApi = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechApi) {
    showMessage("This browser does not support speech recognition.", 'error');
    return;
  }

  // Mikrofon iznini aÃ§Ä±kÃ§a talep et (Ã¶zellikle Opera GX / mobil iÃ§in Ã¶nemli)
  try {
    await navigator.mediaDevices.getUserMedia({ audio: true });
  } catch (err) {
    showMessage("Microphone access denied or unavailable.", 'error');
    return;
  }

  // Eski tanÄ±ma nesnesini temizle
  if (recognition) {
    recognition.abort();
    recognition = null;
  }

  recognition = new SpeechApi();
  recognition.lang = 'en-US';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.continuous = false;

  recognition.onstart = () => {
    speakBtn.classList.add('active');
    speakBtn.textContent = 'Listening...';
    showMessage('Speak now!');
  };

  recognition.onresult = (event) => {
    const spoken = event.results[0][0].transcript.trim().toLowerCase();
    currentItem.tries = (currentItem.tries || 0) + 1;

    const isCorrect = spoken.includes(targetWord.toLowerCase());

    if (isCorrect) {
      currentItem.hits = (currentItem.hits || 0) + 1;
      showMessage('âœ“ Great job!', 'success');
      confetti({
        particleCount: 120,
        spread: 80,
        startVelocity: 30,
        origin: { y: 0.65 }
      });
    } else {
      showMessage(`Heard: â€œ${spoken}â€`, 'error');
    }

    // localStorageâ€™a yaz
    localStorage.setItem('subjectWords', JSON.stringify(wordList));
  };

  recognition.onerror = (event) => {
    let txt = 'Speech recognition error';
    if (event.error === 'no-speech')      txt = 'No speech detected';
    else if (event.error === 'audio-capture') txt = 'Microphone not working';
    else if (event.error === 'not-allowed')   txt = 'Microphone permission denied';
    else if (event.error) txt += `: ${event.error}`;

    showMessage(txt, 'error');
  };

  recognition.onend = () => {
    speakBtn.classList.remove('active');
    speakBtn.textContent = 'ðŸŽ¤ Speak to Practice';
    // otomatik tekrar baÅŸlatma yok â†’ kullanÄ±cÄ± tekrar tÄ±klamalÄ±
  };

  try {
    recognition.start();
  } catch (err) {
    showMessage('Failed to start listening', 'error');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  const params = new URLSearchParams(location.search);
  const key = params.get('key')?.trim().toLowerCase();

  if (!key) {
    targetEl.textContent = '(no key)';
    showMessage('Missing ?key= parameter', 'error');
    return;
  }

  try {
    wordList = JSON.parse(localStorage.getItem('subjectWords') || '[]');
  } catch {
    wordList = [];
  }

  currentItem = wordList.find(
    w => w.name?.toLowerCase() === key || w.scrambled?.toLowerCase() === key
  );

  if (!currentItem?.name) {
    targetWord = key;
    targetEl.textContent = key;
    imageEl.src = '';
    showMessage('Word not found in localStorage', 'error');
    return;
  }

  targetWord = currentItem.name;
  targetEl.textContent = targetWord;
  imageEl.src = currentItem.img || '';

  // GÃ¶rsel yÃ¼klenemezse gizle/boÅŸ bÄ±rak
  imageEl.onerror = () => { imageEl.style.display = 'none'; };
}

// BaÅŸlat
init();

// Buton olayÄ±nÄ± baÄŸla
speakBtn.onclick = startRecognition;
</script>
</body>
</html>
