<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Practice | Speaking</title>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <style>
    :root {
      --bg: #0b1120;
      --card: rgba(255,255,255,0.06);
      --accent: #00ff9d;
      --danger: #ff4d6a;
      --success: #00ff9d;
      --text: #e0f7ff;
      --text-muted: #94a3b8;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      height: 100dvh;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
      display: grid;
      place-items: center;
      overflow: hidden;
    }
    .card {
      background: var(--card);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 28px;
      padding: 2.8rem 2rem;
      width: min(92vw, 420px);
      box-shadow: 0 30px 70px -20px rgba(0,0,0,0.6);
      text-align: center;
    }
    #word-image {
      width: 100%;
      height: 220px;
      object-fit: cover;
      border-radius: 16px;
      background: #000;
      margin-bottom: 1.8rem;
      box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    }
    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      letter-spacing: 1.5px;
      color: var(--accent);
      margin-bottom: 2rem;
      text-transform: capitalize;
    }
    button {
      width: 100%;
      padding: 1.1rem;
      margin-bottom: 1rem;
      border-radius: 16px;
      border: none;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.22s ease;
      user-select: none;
    }
    .btn-listen {
      background: white;
      color: #0f172a;
    }
    .btn-listen:hover { background: #f1f5f9; transform: translateY(-1px); }
    .btn-speak {
      background: rgba(0, 255, 157, 0.12);
      color: var(--accent);
      border: 1.5px solid var(--accent);
    }
    .btn-speak:hover:not(:disabled) {
      background: rgba(0, 255, 157, 0.22);
      transform: translateY(-1px);
    }
    .btn-speak.active {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
      animation: pulse 1.8s infinite ease-in-out;
    }
    @keyframes pulse {
      0%,100% { transform: scale(1); }
      50% { transform: scale(1.06); }
    }
    #msg {
      min-height: 3rem;
      margin-top: 1.2rem;
      font-size: 1.3rem;
      font-weight: 700;
      line-height: 1.4;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .success { color: var(--success); animation: pop 0.6s ease; }
    .error { color: var(--danger); }
    @keyframes pop {
      0% { transform: scale(0.5); opacity: 0; }
      60% { transform: scale(1.3); }
      100% { transform: scale(1); opacity: 1; }
    }
    #result-icon {
      font-size: 2.5rem;
    }
  </style>
</head>
<body>
<div class="card">
  <img id="word-image" src="" alt="Word visual" crossorigin="anonymous">
  <h1 id="target-text">...</h1>
  <button class="btn-listen" type="button" onclick="playWord()">ðŸ”Š Listen</button>
  <button id="speakBtn" class="btn-speak" type="button">ðŸŽ¤ Start Speaking</button>
  <div id="msg"></div>
</div>

<script>
const msgEl = document.getElementById('msg');
const speakBtn = document.getElementById('speakBtn');
const targetEl = document.getElementById('target-text');
const imageEl = document.getElementById('word-image');

let targetWord = "test";
let wordList = [];
let currentItem = null;
let recognition = null;
let isListening = false;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showMessage(text, className = '', icon = '') {
  msgEl.innerHTML = icon ? `<span id="result-icon">${icon}</span> ${text}` : text;
  msgEl.className = className;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playWord() {
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(targetWord);
  u.lang = 'en-US';
  u.rate = 1.0;
  u.pitch = 1.0;
  speechSynthesis.speak(u);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleRecognition() {
  if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
    showMessage("Browser doesn't support speech recognition.<br>Try Chrome/Edge.", 'error');
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (isListening) {
    if (recognition) recognition.stop();
    return; // stop() â†’ onend tetiklenir
  }

  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(() => {
      recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.continuous = false;

      recognition.onstart = () => {
        isListening = true;
        speakBtn.classList.add('active');
        speakBtn.textContent = 'ðŸ›‘ Stop & Send';
        showMessage('Speak the word clearly!');
      };

      recognition.onresult = (event) => {
        const spoken = event.results[0][0].transcript.trim().toLowerCase();
        currentItem.tries = (currentItem.tries || 0) + 1;

        const isCorrect = spoken.includes(targetWord.toLowerCase()) || spoken === targetWord.toLowerCase();

        if (isCorrect) {
          currentItem.hits = (currentItem.hits || 0) + 1;
          showMessage(`Great! Heard: "${spoken}"`, 'success', 'âœ…');
          confetti({ particleCount: 160, spread: 100, origin: { y: 0.6 } });
        } else {
          showMessage(`Heard: "${spoken}" â€“ try again`, 'error', 'âŒ');
        }

        saveStats();
      };

      recognition.onerror = (event) => {
        let txt = 'Error: ';
        if (event.error === 'no-speech') txt += 'No speech detected.';
        else if (event.error === 'audio-capture') txt += 'Microphone problem.';
        else if (event.error === 'not-allowed') txt += 'Permission denied.';
        else txt += event.error;
        showMessage(txt, 'error');
      };

      recognition.onend = () => {
        speakBtn.classList.remove('active');
        speakBtn.textContent = 'ðŸŽ¤ Start Speaking';
        isListening = false;
        // EÄŸer result gelmediyse (cancel vs.) mesajÄ± koru veya temizle
        if (!msgEl.classList.contains('success') && !msgEl.classList.contains('error')) {
          showMessage('Ready for next try');
        }
      };

      recognition.start();
    })
    .catch(err => {
      showMessage('Microphone access denied: ' + err.message, 'error');
    });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveStats() {
  localStorage.setItem('subjectWords', JSON.stringify(wordList));
  // Admin.html iÃ§in global istatistik de tutabiliriz (isteÄŸe baÄŸlÄ±)
  const stats = {
    word: targetWord,
    tries: currentItem.tries || 0,
    hits: currentItem.hits || 0,
    timestamp: new Date().toISOString(),
    accuracy: currentItem.tries ? ((currentItem.hits / currentItem.tries) * 100).toFixed(1) + '%' : '0%'
  };
  // TÃ¼m denemeleri array olarak sakla (admin'de listelemek iÃ§in)
  let allStats = JSON.parse(localStorage.getItem('allSpeakingStats') || '[]');
  allStats.push(stats);
  localStorage.setItem('allSpeakingStats', JSON.stringify(allStats));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  const params = new URLSearchParams(location.search);
  const key = params.get('key')?.trim().toLowerCase();
  if (!key) {
    targetEl.textContent = '(no key)';
    showMessage('Use ?key=WORD in URL', 'error');
    return;
  }

  try {
    wordList = JSON.parse(localStorage.getItem('subjectWords') || '[]');
  } catch {
    wordList = [];
  }

  currentItem = wordList.find(w => 
    w.name?.toLowerCase() === key || w.scrambled?.toLowerCase() === key
  );

  if (!currentItem?.name) {
    targetWord = key;
    targetEl.textContent = key;
    imageEl.src = '';
    showMessage('Word not found in storage', 'error');
    return;
  }

  targetWord = currentItem.name;
  targetEl.textContent = targetWord;
  imageEl.src = currentItem.img || '';
  imageEl.onerror = () => { imageEl.style.display = 'none'; };

  showMessage('Ready â€“ press to start');
}

init();
speakBtn.onclick = toggleRecognition;
</script>
</body>
</html>
